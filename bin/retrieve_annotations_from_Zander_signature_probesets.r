setwd(".")
options(stringsAsFactors = FALSE)
cat("\014")

list.of.packages <- c("easypackages", "plyr") # other packages
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

source("utils.r")

# For the printed files
num_to_return <- 1
exe_num <- sample(1:as.numeric(10000), num_to_return)


if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
listOfBiocPackages <- c("annotate", "GEOquery")

bioCpackagesNotInstalled <- which( !listOfBiocPackages %in% rownames(installed.packages()) )
cat("package missing listOfBiocPackages[", bioCpackagesNotInstalled, "]: ", listOfBiocPackages[bioCpackagesNotInstalled], "\n", sep="")

# check there's still something left to install
if( length(bioCpackagesNotInstalled) ) {
    BiocManager::install(listOfBiocPackages[bioCpackagesNotInstalled])
}

library("easypackages")
libraries(list.of.packages)
libraries(listOfBiocPackages)

thisGEOplatform <- "GPL6102"
# we use this platform and not the other one because we find all the probesets there


ZanderSignatureProbesets <- c("2370524", "510450", "4760543", "7550537", "6270128", "2630484", "520332", "4900053", "4730195", "4280332", "1110215", "670041", "650164", "3460674", "1820598", "6960746", "3120301", "3360364", "6110768", "3990639", "7150634", "6590386", "5690037", "1780348", "450037", "4540082", "6380598", "3520192", "7380288", "2450497", "6980070", "5390131", "1240603", "5900156", "2190673", "2690609", "1580348", "4220138", "4850192", "6480500", "7100136", "3610504", "2630451", "3520082",
 "7160296", "1050128", "4730577", "6280754", "5960035", "5910091", "1430292", "4210647", "3460189", "3140093", "5700403", "160132", "460754", "1440601", "3830390", "5860196", "3420735", "7050543", "6270021", "5290289", "6590523", "1710286",
 "2630154", "2640609", "6020402", "5550746", "4060131", "160736", "610563", "3840022", "20647", "6290431", "3370687", "5310754", "2710397", "7320576", "7150017", "4850541", "6100220", "10541", "3170092", "5720398", "4540301", "2100035", "5090477", "2680370", "130403", "6290561", "5390669", "2760563", "1440382", "2260446", "2030544", "6940242", "1440546",
 "5270500", "5130082", "2750408", "6980274", "4200538", "6550142", "7000408", "3140246", "4230653", "5310653", "3420343", "4150402", "2100333", "4150161", "4880364", "2230661", "380685", "2450343", "6840408", "7000133", "1430762", "3140039", "2900524", "6480170", "4120133", "1170307", "1110575", "4780743", "7150601", "5310050", "3130091", "4860132", "3780689",
 "1030692", "4830435", "3440431", "4830563", "3940368", "1980424", "3130711", "620722", "3400504", "2750521", "4060056", "4640044", "6110537", "4640528", "5860400", "3420630", "4180142", "6350364", "2760092", "990273", "3990465", "1260228", "4860296", "1300768", "840730", "1110358", "5130767", "6980609", "2630719", "7380274", "6480328", "3370605", "5820348",
 "130113", "6860243", "1400270", "5310136", "5890327", "5900414", "1340338", "2850576", "6960328", "20224", "4560463", "6380148", "5490142", "150632", "240653", "2750070", "6020575", "3710189", "2710278", "360343", "4050398", "6940246", "2690576", "5130475", "2120681", "1690189", "1410369", "4850438", "7100392", "1340731", "2450603", "3390458", "1990673",
 "4150632", "130451", "10338", "1500040", "4590082", "730725", "3800270", "5090204", "3170468", "50164", "4050411", "380315", "6650541", "1440291", "4880373", "2120356", "160682", "4280047", "3890095", "1740576", "2480082", "6110328", "6660056", "6420541", "6770348", "1500717", "7330487", "2510324", "2760110", "2000551", "3140142", "6400563", "7000768", "2030450",
 "3930687", "770452", "4390615", "2190524", "6350360", "460273", "160240", "5360674", "4920577", "4760364", "4150768", "2970332", "360066", "2370341", "940754", "1090048", "5910343", "2810674", "3800253", "6760487", "6350017", "2000390", "360402", "7650025", "6270364", "7510224", "3850025", "2640373", "1940543", "1820142", "3400328", "1470332", "2070241",
 "6200746", "5130154", "7650605", "3990296", "990224", "6110142", "520154", "2650164", "6370463", "6020500", "3800243", "7380328", "4200451", "1430156", "2490747", "1010612", "2630181", "1450082", "3940020", "2970440", "3990192", "3830278",
 "650541", "2070131", "6040259", "650014", "1690504", "5080056", "6220450", "7100504", "2100221", "6280576", "5890273", "4780672", "7610546", "6020132", "6110133", "2000474", "1500328", "2030747", "5560093", "610465", "3400372", "6580075", "5130747", "650358", "6650576", "5960128", "1190647", "2510133", "4120086", "3130019", "4200148", "940706", "20553", "5550270", "4570612", "770458", "3390008", "2970768", "4730088", "670376", "5960301", "7400431", "520360", "1240440", "2320309", "4220181", "6380358", "7400240", "6110672", "7050196", "6420079", "1070377", "7380170", "50347", "520647", "6510452", "5130142", "6770142", "3400176", "4010053", "610653", "3940386", "4590646", "2100519", "2710711", "5130553",
 "5690008", "7160164", "6290239", "4610619", "4010673", "3780220", "3440040", "6110088", "6040639", "430100", "2680682", "5270450", "4900497", "6250338", "5720424", "3610634", "5860075", "5570632", "2650152", "5390100", "6380050", "5560280", "4260053", "4810327", "1030039", "5720497", "630091", "5900021", "2850274", "1710100", "6650482", "6040196", "2510132",
 "3460242", "5870300", "1010754", "4540088", "630768", "3840131", "5050390", "730543", "4280373", "840139", "2650390", "20154", "830400", "7380241", "3990328", "3940338", "7650458", "6110132", "3130291", "7380347", "2970537", "6550762", "1030041", "5420538", "1820341", "2370593", "240608", "6650403", "3710228", "1090139", "10025", "290452", "2070494", "6480458", "830754", "5570750", "5090554", "5090047", "4880681", "7200477", "7400121", "2750035", "3290019", "3130300", "3850020", "5670274",
 "2760064", "5570661", "5090315", "3140088", "4010048", "7380736", "1170139", "5260184", "6660709", "2900482", "7320594", "6350376", "4900398", "2850288", "6660471", "2070152", "6650020", "1710189", "6620674", "5890494", "7160767", "1510224", "380541", "1450523", "6520241", "60468", "5720458", "6110228", "5720347", "580050", "4890192", "2900463", "3780243",
 "5090647", "940348", "5340162", "7560603", "5820465", "1780152", "2750626", "7000224", "3420682", "1470541", "940450", "1780035", "6270215", "840564", "5050653", "1070189", "650767", "6280168", "2640278")












    # we retrieve the platform details
    platform_ann <- readGEOAnn(GEOAccNum = thisGEOplatform)
    platform_ann_df <- as.data.frame(platform_ann, stringsAsFactors=FALSE)
    print("sort(names(platform_ann_df))")
    print(sort(names(platform_ann_df)))

    geneSymbolFlag <- TRUE
    geneSymbolAssignment <- FALSE
    
    emptyGeneSymbol <- ""
    FIRST_GENE_EXPRESSION_INDEX <- 2
    
if(thisGEOplatform == "GPL6097") {
	theseGenes <- platform_ann_df[platform_ann_df$"ID" %in% ZanderSignatureProbesets,] 
	# unsure it's "ID"
	print(theseGenes[,c(1:3)], sep="\n")
} else if(thisGEOplatform == "GPL6102") {
	theseGenes <- platform_ann_df[platform_ann_df$"Array_Address_Id" %in% ZanderSignatureProbesets,]
	print(theseGenes[,c("Array_Address_Id", "Symbol", "SEQUENCE")], sep="\n")
	
	probesets_IDs_symbols_sequences <- theseGenes[,c("Array_Address_Id", "Symbol", "SEQUENCE")]
}
         


numProbesetsFound <- nrow(theseGenes)	
numProbesetZanderSignature <- length(ZanderSignatureProbesets)
percProbesetsFound <- numProbesetsFound*100/numProbesetZanderSignature

cat("The script found ", numProbesetsFound, " probesets out of ", numProbesetZanderSignature, " (", percProbesetsFound,"%) \n", sep="")


outputFile <- paste0("../results/Zander_signature_", thisGEOplatform, "_probesets_sequences_symbols_rand", exe_num,".csv")
write.csv(probesets_IDs_symbols_sequences, file=outputFile, row.names=FALSE)
